<html>
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="description" content="">
  <meta name="author" content="">

  <title>Fallow Dart MGR - Join</title>
  <script src="../js/jquery.js"></script>
  <script src="../js/bootstrap.min.js"></script>
  <script src="../js/bootstrap-slider.js"></script>
  <script src="../js/util.js"></script>

  <link href="../css/bootstrap.min.css" rel="stylesheet">
  <link href="../css/style.css" rel="stylesheet">
</head>

<body>
  <div id="gameId"></div>
  <input type="text" name="fname" id="name" placeholder="Your Name"/>
  <div id="join" class="btn btn-success">Join</div>
  <div id="start" class="btn btn-primary disabled">Start</div>
  <div id="players"></div>
  <script>
    var params = GetUrlParams();
    if(params.id === undefined)
      window.location = "/";

    var game = {};
    var playerId = "";

    UpdateGame();
    setInterval(function(){
      UpdateGame();
    }, 1000);

    $("#join").on("click", function(e){
      if(game.Id === undefined)
        return;
      if($("#name").val() === "")
        return;
      $.post("/join", {Id:game.Id, Name:$("#name").val()}, function(e){
        try {
          var res = JSON.parse(e);
          if (res === undefined || res.Id === undefined)
            throw "Invalid game id";
          $("#join").hide();
          $("#name").hide();
          playerId = res.Id;
        } catch(ex){
          window.location = "/join";
        }
      });
    });

    $("#start").on("click", function(e){
      $.post("/start", {Id:game.Id});
    });

    function UpdateGame() {
        $.post("/game", {Id: params.id}, function(e){
          try {
            var res = JSON.parse(e);
            if (res === undefined || res.Id === undefined)
              throw "Invalid game id";
            Initialize(res);
          } catch(ex){
            window.location = "/";
          }
        });
    }

    function Initialize(gameData) {
      game = gameData;
      $("#gameId").text(game.Id);
      if(game.IsHost === true)
        $("#start").removeClass("disabled");
      $("#players").html("");
      for(let i=0;i<game.Players.length;i++){
        $("#players").append("<div class='player'>" + game.Players[i].Name + "</div>");
      }
      if(game.GameState !== -1)
        window.location = "/game?id=" + game.Id + ((playerId === "") ? "" : ("&playerId=" + playerId));
    }
  </script>
</body>

</html>
